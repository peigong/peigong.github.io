<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>学习TANX SSP的javascript代码 | VET. 周培公</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="系统概览总体的逻辑架构 广告投放系统系统概览逻辑架构 时序略图 TANX SSP的系统入口做为TANX SSP的系统入口，需要在网站(如有问必答)上嵌入阿里妈妈的广告调度代码。如： &lt;script type&#x3D;&quot;text&#x2F;javascript&quot;&gt;     alimama_pid&#x3D;&quot;mm_37227883_3484494_11371704&quot;;">
<meta property="og:type" content="article">
<meta property="og:title" content="学习TANX SSP的javascript代码">
<meta property="og:url" content="http://pg.js.cn/articles/it-studio-2013-05-20-tanx-ssp-javascript-code.html">
<meta property="og:site_name" content="VET. 周培公">
<meta property="og:description" content="系统概览总体的逻辑架构 广告投放系统系统概览逻辑架构 时序略图 TANX SSP的系统入口做为TANX SSP的系统入口，需要在网站(如有问必答)上嵌入阿里妈妈的广告调度代码。如： &lt;script type&#x3D;&quot;text&#x2F;javascript&quot;&gt;     alimama_pid&#x3D;&quot;mm_37227883_3484494_11371704&quot;;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://pg.js.cn/images/projects/tanx-ssp/logical-framework.png">
<meta property="og:image" content="http://pg.js.cn/images/projects/tanx-ssp/ali-ad-system.png">
<meta property="og:image" content="http://pg.js.cn/images/projects/tanx-ssp/ali-ad-system-sequence.png">
<meta property="og:image" content="http://pg.js.cn/images/projects/tanx-ssp/taobao-show.png">
<meta property="og:image" content="http://pg.js.cn/images/projects/tanx-ssp/taobao-show-sequence.png">
<meta property="og:image" content="http://pg.js.cn/images/projects/tanx-ssp/ad-click-stat.png">
<meta property="og:image" content="http://pg.js.cn/images/projects/tanx-ssp/ali-cookie-beacon.png">
<meta property="og:image" content="http://pg.js.cn/images/projects/tanx-ssp/ali-cookie-beacon-sequence.png">
<meta property="og:image" content="http://pg.js.cn/images/projects/tanx-ssp/static-server.png">
<meta property="article:published_time" content="2013-05-19T16:00:00.000Z">
<meta property="article:modified_time" content="2024-08-29T16:00:00.000Z">
<meta property="article:author" content="VET. 周培公">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://pg.js.cn/images/projects/tanx-ssp/logical-framework.png">
  
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">VET. 周培公</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">写 JS 代码的周培公是一个兽医</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">首页</a>
        
          <a class="main-nav-link" href="/proposals">写作计划</a>
        
          <a class="main-nav-link" href="/books">藏书目录</a>
        
      </nav>
      <nav id="sub-nav">
        
          
            <a class="nav-icon" target="_blank" rel="noopener" href="https://github.com/peigong"><span class="fa fa-github"></span></a>
          
            <a class="nav-icon" target="_blank" rel="noopener" href="https://gitee.com/pg0xff"><span class="fa fa-git"></span></a>
          
            <a class="nav-icon" target="_blank" rel="noopener" href="https://user.qzone.qq.com/377650913"><span class="fa fa-qq"></span></a>
          
            <a class="nav-icon" target="_blank" rel="noopener" href="https://weibo.com/u/1766654653"><span class="fa fa-weibo"></span></a>
          
            <a class="nav-icon" href="https://pg.js.cn"><span class="fa fa-home"></span></a>
          
        
        
      </nav>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-it-studio-2013-05-20-tanx-ssp-javascript-code" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/articles/it-studio-2013-05-20-tanx-ssp-javascript-code.html" class="article-date">
  <time class="dt-published" datetime="2013-05-19T16:00:00.000Z" itemprop="datePublished">2013-05-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/it/">IT</a>►<a class="article-category-link" href="/categories/it/studio/">学习笔记</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      学习TANX SSP的javascript代码
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="系统概览"><a href="#系统概览" class="headerlink" title="系统概览"></a>系统概览</h2><h3 id="总体的逻辑架构"><a href="#总体的逻辑架构" class="headerlink" title="总体的逻辑架构"></a>总体的逻辑架构</h3><p><img src="/images/projects/tanx-ssp/logical-framework.png" alt="逻辑架构"></p>
<h2 id="广告投放系统"><a href="#广告投放系统" class="headerlink" title="广告投放系统"></a>广告投放系统</h2><h3 id="系统概览-1"><a href="#系统概览-1" class="headerlink" title="系统概览"></a>系统概览</h3><h4 id="逻辑架构"><a href="#逻辑架构" class="headerlink" title="逻辑架构"></a>逻辑架构</h4><p><img src="/images/projects/tanx-ssp/ali-ad-system.png" alt="逻辑架构"></p>
<h4 id="时序略图"><a href="#时序略图" class="headerlink" title="时序略图"></a>时序略图</h4><p><img src="/images/projects/tanx-ssp/ali-ad-system-sequence.png" alt="时序略图"></p>
<h3 id="TANX-SSP的系统入口"><a href="#TANX-SSP的系统入口" class="headerlink" title="TANX SSP的系统入口"></a>TANX SSP的系统入口</h3><p>做为TANX SSP的系统入口，需要在网站(如<a target="_blank" rel="noopener" href="http://www.120ask.com/zxmrk/28/28109815.htm">有问必答</a>)上嵌入阿里妈妈的广告调度代码。如：</p>
<pre><code>&lt;script type=&quot;text/javascript&quot;&gt;
    alimama_pid=&quot;mm_37227883_3484494_11371704&quot;;
    alimama_width=300;
    alimama_height=250;
&lt;/script&gt;
&lt;script src=&quot;http://a.alimama.cn/inf.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
</code></pre>
<p>以上广告代码中的关键信息意义如下：</p>
<ul>
<li>alimama_pid： 广告位编号</li>
<li>alimama_width：广告位的宽度</li>
<li>alimama_height：广告位的高度</li>
<li>inf.js：阿里妈妈的广告前端系统入口点</li>
</ul>
<h3 id="阿里妈妈的广告前端系统"><a href="#阿里妈妈的广告前端系统" class="headerlink" title="阿里妈妈的广告前端系统"></a>阿里妈妈的广告前端系统</h3><h4 id="前端系统入口点（inf-js）"><a href="#前端系统入口点（inf-js）" class="headerlink" title="前端系统入口点（inf.js）"></a>前端系统入口点（inf.js）</h4><p>阿里妈妈的广告前端系统的入口点（inf.js）中，首先对包和模块进行定义。代码如下：</p>
<pre><code>var l = &#123;
    lt_pkgs: &#123;
        inf: &quot;http://a.alimama.cn/&quot;,
        packages: &quot;http://a.alimama.cn/inf/&quot;
    &#125;,
    lt_v: &quot;1.1.5&quot;,
    lt_t: &quot;20130523.js&quot;
&#125;;
</code></pre>
<p>意义如下：</p>
<ul>
<li>lt_pkgs：包路径信息。</li>
<li>lt_v：版本 如 1.1.5。</li>
<li>lt_t：时间戳比如 20101129.js</li>
</ul>
<p>参见kslite框架开发团队的github项目<a target="_blank" rel="noopener" href="https://github.com/etaoux/kslite">etaoux&#x2F;kslite</a></p>
<p>kslite框架会根据包和模块的定义，异步加载模块的入口点（inf&#x2F;main.js）。</p>
<h4 id="模块入口点（inf-main-js）"><a href="#模块入口点（inf-main-js）" class="headerlink" title="模块入口点（inf&#x2F;main.js）"></a>模块入口点（inf&#x2F;main.js）</h4><p>kslite框架加载模块入口点（inf&#x2F;main.js）脚本时，会携带参数。如下：</p>
<p><strong>GET参数</strong></p>
<ul>
<li>_t：20130523.js，向服务器要求指定构建版本的脚本文件。</li>
</ul>
<p>在模块的入口点（inf&#x2F;main.js）脚本中，负责向常规广告调度系统发出广告调度请求。</p>
<h3 id="常规的广告调度系统（http-p-tanx-com-ex）"><a href="#常规的广告调度系统（http-p-tanx-com-ex）" class="headerlink" title="常规的广告调度系统（http://p.tanx.com/ex）"></a>常规的广告调度系统（<a target="_blank" rel="noopener" href="http://p.tanx.com/ex%EF%BC%89">http://p.tanx.com/ex）</a></h3><p>提供常规广告调度服务的URL地址是<a target="_blank" rel="noopener" href="http://p.tanx.com/ex%EF%BC%8C%E8%B4%9F%E8%B4%A3%E6%8E%A5%E6%94%B6%E7%94%B1%E9%98%BF%E9%87%8C%E5%A6%88%E5%A6%88%E5%B9%BF%E5%91%8A%E5%89%8D%E7%AB%AF%E7%B3%BB%E7%BB%9F%E5%8F%91%E8%B5%B7%E7%9A%84%E5%B9%BF%E5%91%8A%E8%B0%83%E5%BA%A6%E8%AF%B7%E6%B1%82%EF%BC%8C%E8%BF%9B%E8%A1%8C%E5%B8%B8%E8%A7%84%E7%9A%84%E3%80%81%E4%B8%8D%E9%99%90%E4%BA%8ETANX">http://p.tanx.com/ex，负责接收由阿里妈妈广告前端系统发起的广告调度请求，进行常规的、不限于TANX</a> SSP的广告调度。</p>
<h4 id="广告调度请求的参数"><a href="#广告调度请求的参数" class="headerlink" title="广告调度请求的参数"></a>广告调度请求的参数</h4><p><strong>GET参数</strong></p>
<ul>
<li>参数i：广告位编号，如mm_37227883_3484494_11371704。</li>
</ul>
<p><strong>Cookie参数</strong></p>
<ul>
<li>cna：域为.tanx.com，路径为&#x2F;，过期时间是25年以后。值如mqEwCpEPWVYCAfKFf3xLEFf3。</li>
</ul>
<p>当客户端存有TANX域的Cookie时，广告调度请求携带Cookie参数。没有Cookie，则不必携带。</p>
<h4 id="广告调度请求的响应"><a href="#广告调度请求的响应" class="headerlink" title="广告调度请求的响应"></a>广告调度请求的响应</h4><p>在接收到以广告位编号为主要参数的调度请求后，调度系统根据特定的广告调度逻辑，确定是否为该广告位提供TANX服务，然后回复特定分支的200 OK响应。</p>
<p>200 OK中定义TANX服务的关键数据如下：</p>
<pre><code>var o = &#123; 
        ... ...
        sd : &quot;toruk.tanx.com&quot; 
    &#125;, 
    p = &#123; 
        c : &#39;gbk&#39;, 
        s : &#39;http://cdn.tanx.com/t/tanxssp.js&#39; 
    &#125;; 
</code></pre>
<p>主要定义的是：</p>
<ul>
<li>TANX调度服务器域名的定义。</li>
<li>TANX服务的入口点脚本（tanxssp.js）</li>
</ul>
<p>这一设计，为广告流量的灵活分配提供了可能性，可以用于小流量测试、负载分担、单一化系统职责等各种场景。</p>
<h4 id="加载TANX服务的入口点脚本（tanxssp-js）"><a href="#加载TANX服务的入口点脚本（tanxssp-js）" class="headerlink" title="加载TANX服务的入口点脚本（tanxssp.js）"></a>加载TANX服务的入口点脚本（tanxssp.js）</h4><p>广告调度请求的200 OK响应会执行程序，加载TANX SSP的广告前端系统的入口点脚本（tanxssp.js）。</p>
<p><strong>Cookie参数</strong></p>
<ul>
<li>cna：域为.tanx.com，路径为&#x2F;，过期时间是25年以后。值如mqEwCpEPWVYCAfKFf3xLEFf3。</li>
</ul>
<p>如果浏览器客户端存在TANX域的Cookie，在加载入口点时携带Cookie信息。如果没有，则不必携带。</p>
<h3 id="TANX-SSP的广告前端系统"><a href="#TANX-SSP的广告前端系统" class="headerlink" title="TANX SSP的广告前端系统"></a>TANX SSP的广告前端系统</h3><h4 id="系统的入口点（tanxssp-js）"><a href="#系统的入口点（tanxssp-js）" class="headerlink" title="系统的入口点（tanxssp.js）"></a>系统的入口点（tanxssp.js）</h4><p>如同阿里妈妈的入口点脚本，TANX SSP的入口点（tanxssp.js）也首先对模块和包进行了定义。如：</p>
<pre><code>var l = &#123;
    lt_pkgs: &#123;
        tanxssp: &quot;http://cdn.tanx.com/t/&quot;,
        charset: &quot;gbk&quot;
    &#125;,
    lt_v: &quot;1.0.0&quot;,
    lt_t: &quot;20130516.js&quot;
&#125;;
</code></pre>
<p>与其不同的是，对同步加载时需要的模块入口点地址也进行了定义。如：</p>
<pre><code>var a = &quot;http://cdn.tanx.com/t/tanxssp/main.js?_t=20130516&quot;;
</code></pre>
<p>kslite框架会异步或同步的加载模块的入口文件（tanxssp&#x2F;main.js）。</p>
<h4 id="模块的入口点（tanxssp-main-js）"><a href="#模块的入口点（tanxssp-main-js）" class="headerlink" title="模块的入口点（tanxssp&#x2F;main.js）"></a>模块的入口点（tanxssp&#x2F;main.js）</h4><p>加载模块入口点（tanxssp&#x2F;main.js）脚本时携带参数。如下：</p>
<p><strong>GET参数</strong></p>
<ul>
<li>_t：20130523.js，向服务器要求指定构建版本的脚本文件。</li>
</ul>
<p><strong>Cookie参数</strong></p>
<ul>
<li>cna：域为.tanx.com，路径为&#x2F;，过期时间是25年以后。值如mqEwCpEPWVYCAfKFf3xLEFf3。</li>
</ul>
<p>当客户端存有TANX域的Cookie时，携带Cookie参数。没有Cookie，则不必携带。</p>
<p>在模块的入口点（tanxssp&#x2F;main.js）脚本中，负责组装广告请求参数，向TANX广告调度系统(<a target="_blank" rel="noopener" href="http://toruk.tanx.com/ex)%E5%8F%91%E5%87%BA%E5%B9%BF%E5%91%8A%E8%B0%83%E5%BA%A6%E8%AF%B7%E6%B1%82%E3%80%82">http://toruk.tanx.com/ex)发出广告调度请求。</a></p>
<p>同时，在模块的入口点（tanxssp&#x2F;main.js）脚本中，也定义了TANX广告调度服务响应后，用于回调执行的函数。如：</p>
<pre><code>var k = &quot;jsonp_callback_&quot; + parseInt(Math.random() * 100000, 10);
window[k] = function(s) &#123;... ...&#125;
</code></pre>
<h3 id="TANX广告调度系统-http-toruk-tanx-com-ex"><a href="#TANX广告调度系统-http-toruk-tanx-com-ex" class="headerlink" title="TANX广告调度系统(http://toruk.tanx.com/ex)"></a>TANX广告调度系统(<a target="_blank" rel="noopener" href="http://toruk.tanx.com/ex">http://toruk.tanx.com/ex</a>)</h3><p>提供TANX广告调度服务的URL地址是<a target="_blank" rel="noopener" href="http://toruk.tanx.com/ex%EF%BC%8C%E8%B4%9F%E8%B4%A3%E6%8E%A5%E6%94%B6%E7%94%B1TANX%E5%B9%BF%E5%91%8A%E5%89%8D%E7%AB%AF%E7%B3%BB%E7%BB%9F%E5%8F%91%E8%B5%B7%E7%9A%84%E5%B9%BF%E5%91%8A%E8%B0%83%E5%BA%A6%E8%AF%B7%E6%B1%82%E3%80%82">http://toruk.tanx.com/ex，负责接收由TANX广告前端系统发起的广告调度请求。</a></p>
<p>这里的toruk.tanx.com，是由常规广告调度服务器投放TANX SSP广告时，在200OK的响应中确定的TANX广告调度服务使用的域名。</p>
<h4 id="广告调度请求的参数-1"><a href="#广告调度请求的参数-1" class="headerlink" title="广告调度请求的参数"></a>广告调度请求的参数</h4><p><strong>Cookie参数</strong></p>
<ul>
<li>cna：域为.tanx.com，路径为，过期时间是25年以后。值如mqEwCpEPWVYCAfKFf3xLEFf3。</li>
</ul>
<p>当客户端存有TANX域的Cookie时，广告调度请求携带Cookie参数。没有Cookie，则不必携带。</p>
<p><strong>GET参数</strong></p>
<ul>
<li>i：广告位编号，如mm_37227883_3484494_11371704。</li>
<li>cb：在客户端收到TANX广告调度的响应后，需要执行的回调函数名。在模块的入口点（tanxssp&#x2F;main.js）脚本中定义，通过JSONP实现跨域通信，如jsonp_callback_5021。</li>
<li>callback：</li>
<li>userid：</li>
<li>o：</li>
<li>f：</li>
<li>n：</li>
<li>re：访问者屏幕的尺寸（宽x高）</li>
<li>r：</li>
<li>cah：900</li>
<li>caw：1440</li>
<li>ccd：24</li>
<li>ctz：8</li>
<li>chl：2</li>
<li>cja：1</li>
<li>cpl：23</li>
<li>cmm：75</li>
<li>cf：11.4</li>
<li>cg：a885a4d6b1a8c5c3e3c8c4415cc956c5</li>
<li>ac：6990</li>
<li>prl：93285121</li>
<li>j：</li>
<li>cas：prl</li>
<li>cbh：3412</li>
<li>cbw：1423</li>
<li>dx：1</li>
<li>u：当前访问页面的URL地址，如<a target="_blank" rel="noopener" href="http://www.120ask.com/zxmrk/28/28109815.htm%E3%80%82">http://www.120ask.com/zxmrk/28/28109815.htm。</a></li>
<li>pf</li>
<li>k：</li>
<li>tt：当前访问页面的title，如”月经期间如何丰胸 帮您免费 快速问医生 有问必答网”。</li>
</ul>
<h4 id="广告调度请求的响应-1"><a href="#广告调度请求的响应-1" class="headerlink" title="广告调度请求的响应"></a>广告调度请求的响应</h4><p>TANX广告调度系统(<a target="_blank" rel="noopener" href="http://toruk.tanx.com/ex)%E5%93%8D%E5%BA%94%E7%9A%84%E5%86%85%E5%AE%B9%E6%A0%BC%E5%BC%8F%E5%A6%82%E4%B8%8B%EF%BC%9A">http://toruk.tanx.com/ex)响应的内容格式如下：</a></p>
<pre><code>jsonp_callback_5021(&#123;
    &quot;pid&quot;:&quot;mm_37227883_3484494_11371704&quot;,
    &quot;acookie&quot;:&quot;1&quot;,&quot;width&quot;:&quot;300&quot;,&quot;height&quot;:&quot;250&quot;,
    &quot;distype&quot;:&quot;1&quot;,&quot;webwidth&quot;:&quot;&quot;,&quot;adboardtype&quot;:&quot;98&quot;,&quot;fvs&quot;:&quot;&quot;,&quot;title&quot;:&quot;&quot;,
    &quot;clickurl&quot;:&quot;&quot;,
    &quot;data&quot;:&quot;&lt;iframe scrolling=\&quot;no\&quot; height=250 frameborder=\&quot;0\&quot; width=300 
    style=\&quot;border: 0pt none;\&quot; marginheight=\&quot;0\&quot; allowtransparency=\&quot;true\&quot; 
    marginwidth=\&quot;0\&quot; border=\&quot;0\&quot; 
    src=\&quot;http:\/\/strip.taobaocdn.com\/tfscom\/T1vEk0XatbXXbMsGbX.html?
    name=itemdsp&amp;url=www.120ask.com&amp;iswt=1&amp;pid=tt_37227883_3484494_11371704
    &amp;refpos=,n,i&amp;adx_type=0&amp;pvid=ac17d84c7c3c51a9b39900000012325a_0
    &amp;tanxdspv=http%3A%2F%2Frdstat.tanx.com%2Ftrd%3F%26f%3D%26k%3Da09e279ad7f7a12a
    %26p%3Dmm_37227883_3484494_11371704%26pvid%3D0af6086e0820519ec01b0000000560d8\&quot;
    &gt;&lt;\/iframe&gt;&quot;,
    &quot;icon&quot;:&quot;1&quot;,&quot;feedback&quot;:&quot;&quot;,&quot;unregist&quot;:&quot;&quot;
&#125;);
</code></pre>
<p>jsonp_callback_5021是在模块的入口点（tanxssp&#x2F;main.js）脚本中定义的回调函数，负责将“data”字段中的iframe标签文本输出到页面中，向舞女页面发起请求。舞女页面是整个系统的神来之笔，后文会使用一个比较大的篇幅专题分析。</p>
<h3 id="业务管理系统"><a href="#业务管理系统" class="headerlink" title="业务管理系统"></a>业务管理系统</h3><p>虽然这里只是从前端代码的角度分析整个系统，但是不分析业务管理系统，这个分析就是不完整的。</p>
<p>业务管理系统不外乎两个方向，一个是媒体管理方向，一个是广告管理方向。下面对这两个系统的职责作个简单的分析，不进行深入探讨。</p>
<h4 id="媒体管理系统"><a href="#媒体管理系统" class="headerlink" title="媒体管理系统"></a>媒体管理系统</h4><p>估计系统是使用的是c.tanx.com(原域名：c.alimama.com）这个网站进行媒体管理的。</p>
<p>系统的主要职责如下：</p>
<ul>
<li>获取各种样式的广告位代码。嵌入到网站上，作为整个系统的入口。</li>
<li>查看在媒体、广告位上投放广告情况的报表。</li>
<li>对在媒体上、广告位上投放的广告进行干预</li>
</ul>
<h4 id="广告管理系统"><a href="#广告管理系统" class="headerlink" title="广告管理系统"></a>广告管理系统</h4><p>橱窗推广的广告管理系统应该不是独立的，而是与淘宝网店系统（<a target="_blank" rel="noopener" href="http://www.taobao.com)集成在一起的./">www.taobao.com）集成在一起的。</a></p>
<p>系统主要职责如下：</p>
<ul>
<li>淘宝店主通知系统把自己的指定商品进行橱窗推广。</li>
<li>设定投放的排期，以及计划的价格和投放量。</li>
<li>系统对外提供接口服务，提供需要投放广告的商品的数据。</li>
</ul>
<h2 id="橱窗展示系统"><a href="#橱窗展示系统" class="headerlink" title="橱窗展示系统"></a>橱窗展示系统</h2><h3 id="脱衣舞橱窗展示系统"><a href="#脱衣舞橱窗展示系统" class="headerlink" title="脱衣舞橱窗展示系统"></a>脱衣舞橱窗展示系统</h3><p>漫长的文档看到这里，就像83版《西游记》西梁女国那一集，太师引领着唐僧穿过秩序井然的皇家庭院，突然间闯入女王的寝宫，看到了御床上活色生香、温情脉脉的女王。然而，更让人激动不已的，这里竟然是此行的目的地。</p>
<p>这个系统设计的太高明、太复杂、太有灵性，无法用一个简单的词汇命名，恰好阿里系的架构师们使用了strip.taobaocdn.com域名，姑且就命名为脱衣舞橱窗展示系统吧。</p>
<p>把脱衣舞舞女与女王相提并论，似乎唐突佳人。但是，这里的舞女页面比女王更加顾盼多情、长袖善舞。更了不起的是，你无法记住每一个舞女页面的名字（如T1vEk0XatbXXbMsGbX.html），因为这都是由系统生成出来的，而这个系统必然会有可视化的管理系统去管理。</p>
<h3 id="系统概览-2"><a href="#系统概览-2" class="headerlink" title="系统概览"></a>系统概览</h3><h4 id="逻辑架构-1"><a href="#逻辑架构-1" class="headerlink" title="逻辑架构"></a>逻辑架构</h4><p><img src="/images/projects/tanx-ssp/taobao-show.png" alt="逻辑架构"></p>
<h4 id="时序略图-1"><a href="#时序略图-1" class="headerlink" title="时序略图"></a>时序略图</h4><p><img src="/images/projects/tanx-ssp/taobao-show-sequence.png" alt="时序略图"></p>
<h3 id="舞女页面"><a href="#舞女页面" class="headerlink" title="舞女页面"></a>舞女页面</h3><p>舞女页面是一个纯静态的HTML页面(地址如：<a target="_blank" rel="noopener" href="http://strip.taobaocdn.com/tfscom/T1vEk0XatbXXbMsGbX.html%EF%BC%89%EF%BC%8C%E5%AD%98%E5%82%A8%E5%9C%A8CDN%E5%8A%A0%E9%80%9F%E7%9A%84%E9%9D%99%E6%80%81%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%EF%BC%88strip.taobaocdn.com%EF%BC%89%EF%BC%8C%E7%94%B1%E4%B8%80%E4%B8%AA%E7%B3%BB%E7%BB%9F%E6%8B%BC%E8%A3%85%E7%94%9F%E6%88%90%E3%80%82">http://strip.taobaocdn.com/tfscom/T1vEk0XatbXXbMsGbX.html），存储在CDN加速的静态服务器上（strip.taobaocdn.com），由一个系统拼装生成。</a></p>
<p>在前端系统执行回调函数，向舞女页面发起请求时，会携带一组参数。</p>
<p>舞女页面上的javascript的程序，负责解析使用这一组参数。</p>
<p><strong>GET参数列表</strong></p>
<ul>
<li>name：itemdsp</li>
<li>url：<a target="_blank" rel="noopener" href="http://www.120ask.com/">www.120ask.com</a></li>
<li>iswt：1</li>
<li>pid：tt_37227883_3484494_11371704</li>
<li>refpos：,n,i</li>
<li>adx_type：0</li>
<li>pvid：ac17d84c7c3c51a9b39900000012325a_0</li>
<li>tanxdspv：<a target="_blank" rel="noopener" href="http://rdstat.tanx.com/trd?&f=&k=a09e279ad7f7a12a&p=mm_37227883_3484494_11371704&pvid=ac1797214e9e51a9b39900000018dcd6">http://rdstat.tanx.com/trd?&amp;f=&amp;k=a09e279ad7f7a12a&amp;p=mm_37227883_3484494_11371704&amp;pvid=ac1797214e9e51a9b39900000018dcd6</a></li>
</ul>
<p>舞女页面一手接住前端系统抛来的参数，另一手魔术般的调用淘宝的商品数据服务，将系统中需要展示的橱窗商品在广告位上一一展示出来。</p>
<h3 id="淘宝商品信息的数据服务"><a href="#淘宝商品信息的数据服务" class="headerlink" title="淘宝商品信息的数据服务"></a>淘宝商品信息的数据服务</h3><p>淘宝商品信息数据服务URL的域名是tns.simba.taobao.com，接收舞女页面的请求参数，根据一个业务逻辑，把客户端需要展示的淘宝商品数据返回给舞女页面。</p>
<h4 id="淘宝商品数据服务的请求"><a href="#淘宝商品数据服务的请求" class="headerlink" title="淘宝商品数据服务的请求"></a>淘宝商品数据服务的请求</h4><p><strong>GET参数</strong></p>
<ul>
<li>name：itemdsp</li>
<li>count：10</li>
<li>o：j</li>
<li>p4p：在舞女页面上定义的回调函数名，服务器端的响应会调用这个函数，处理商品数据。如tbcc_p4p_c2013_5_108621_13700760834161370076083497。</li>
<li>url：<a target="_blank" rel="noopener" href="http://www.120ask.com/">www.120ask.com</a></li>
<li>iswt：1</li>
<li>pid：tt_37227883_3484494_11371704</li>
<li>refpos：,n,i</li>
<li>adx_type：0</li>
<li>pvid：ac17d84c7c3c51a9b39900000012325a_0</li>
<li>tanxdspv：<a target="_blank" rel="noopener" href="http://rdstat.tanx.com/trd?&f=&k=a09e279ad7f7a12a&p=mm_37227883_3484494_11371704&pvid=ac1797214e9e51a9b39900000018dcd6">http://rdstat.tanx.com/trd?&amp;f=&amp;k=a09e279ad7f7a12a&amp;p=mm_37227883_3484494_11371704&amp;pvid=ac1797214e9e51a9b39900000018dcd6</a></li>
<li>refpid：tt_37227883_3484494_11371704</li>
</ul>
<p><strong>Cookie参数</strong></p>
<ul>
<li>cna：mqEwCpEPWVYCAfKFf3xLEFf3，域为.taobao.com，路径为&#x2F;，过期时间为25年后。</li>
<li>rdc：P3XUVZqJJhYLY4KiJHnfTK6UAKxdyp9LBUsbuR6TnOrUehYWBL3GaKKgLuzZERZb，域为.simba.taobao.com，路径为&#x2F;，过期时间是一个会话周期。如果有此cookie，则携带此参数。没有这个cookie则不必携带。</li>
</ul>
<p>当客户端存有TANX域的Cookie时，广告调度请求携带Cookie参数。没有Cookie，则不必携带。</p>
<h4 id="淘宝商品数据服务的响应"><a href="#淘宝商品数据服务的响应" class="headerlink" title="淘宝商品数据服务的响应"></a>淘宝商品数据服务的响应</h4><pre><code>tbcc_p4p_c2013_5_108621_13700760834161370076083497 = [&#123;
    &quot;CUSTOMERID&quot;: &quot;&quot;,
    &quot;TITLE&quot;: &quot;\u82cf\u5b89\u771fSwise\u6b63\u54c1\uff01\u6b27\u6839\u7eb1\u4e0a\u8863 
                \u767d\u8272\u77ed\u8896t\u6064&quot;,
    &quot;DESC&quot;: &quot;null&quot;,
    &quot;URL&quot;: &quot;&quot;,
    &quot;RESOURCEID&quot;: &quot;23639392129&quot;,
    &quot;GOODSPRICE&quot;: 24900,
    &quot;REDKEY&quot;: &quot;&quot;,
    &quot;LOCATION&quot;: &quot;\u6d59\u6c5f \u676d\u5dde&quot;,
    &quot;TBGOODSLINK&quot;: &quot;http:\/\/img03.taobaocdn.com\/bao\/uploaded\/i3\/13892021309981906
                \/T1ZdV2XAFdXXXXXXXX_!!0-item_pic.jpg_sum.jpg&quot;,
    &quot;WANGWANGID&quot;: &quot;swise\u65d7\u8230\u5e97&quot;,
    &quot;EURL&quot;: &quot;http:\/\/redirect.simba.taobao.com\/rd?w=mmp4ptest
            &amp;f=http%3A%2F%2Ftao.etao.com%2Fauction%3Fkeyword%3DT%25D0%25F4%26catid%3D50000671
            %26refpid%3Dmm_37227883_3484494_11371704%26digest%3DB41CA84DF7A1F6A5BA9B11A299A4E52F
            %26crtid%3D207543981%26itemid%3D23639392129%26adgrid%3D194389084
            %26eurl%3Dhttp%253A%252F%252Fclick.simba.taobao.com%252Fcc_im%253Fp%253D%2526s%253D101579514
            %2526k%253D288%2526e%253DqXhvVZ1o4lINKsYj8kZeljogOpoXgh03d2ByUOsMbpVCqy%25252BUFBA5jyzOsW4Yd
            u3h21TcM78lZnZxuhrp93p%25252BzmTJuUEeDdZBMu33MUNq72RaC9QIzaMM3a0HSq4LDODxZYVuqHIwgPNzp
            BcBlCh4A0bg0OxrKYkVV9N9YGVqKZDu4YRXY287eUTmrkbeHdEX4g8ojjF7O6GxFvFGRnXPFlSkghrhkAJhGLy4mUa5y9
            ubk8MdSNDD%25252BmWprP1HRmiZRKsdofWb05R4yNH69PRxiz5jEdah9ftU&amp;k=edce2b64d0a4b4b1&quot;,
    &quot;CP&quot;: &quot;&quot;,
    &quot;DISPLAY_RESOLUTION&quot;: &quot;80*80&quot;,
    &quot;RANKSCORE&quot;: &quot;&quot;,
    &quot;ISPREPAY&quot;: &quot;1&quot;,
    &quot;MATCHTYPE&quot;: &quot;&quot;,
    &quot;PRICE&quot;: &quot;&quot;,
    &quot;GRADE&quot;: &quot;54545&quot;,
    &quot;ISMALL&quot;: &quot;1&quot;,
    &quot;ADGEXTENSION&quot;: &quot;location:\u6d59\u6c5f \u676d\u5dde;expire:2524579200;postage:0.00;isSupportVip:0;
            vipDiscountRate:goldCard~100$platinaCard~100$diamondCard~100;isPostFree:1;ordinaryPostFee:0;
            isCommend:0;spuId:216512255;skuPrice:null;isNew:1&quot;,
    &quot;SELLEREXTENSION&quot;: &quot;manjiusong:1;creditPay:1;vertical3C:0;verticalGame:0;sevendaysRefundment:1;matchScore:4.8;
            serviceScore:4.8;speedScore:4.8;realDescribe:1;genuineGuarantee:1;cod:0&quot;,
    &quot;ISHK&quot;: &quot;0&quot;,
    &quot;ISGLOBAL&quot;: &quot;0&quot;,
    &quot;SELL&quot;: &quot;1813&quot;
&#125;, ... ... ]
</code></pre>
<h3 id="淘宝商品特征的数据服务"><a href="#淘宝商品特征的数据服务" class="headerlink" title="淘宝商品特征的数据服务"></a>淘宝商品特征的数据服务</h3><p>淘宝商品特征数据服务的URL是<a target="_blank" rel="noopener" href="http://show.re.taobao.com/feature.htm%EF%BC%8C%E6%8E%A5%E6%94%B6%E8%88%9E%E5%A5%B3%E9%A1%B5%E9%9D%A2%E7%9A%84%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%EF%BC%8C%E6%A0%B9%E6%8D%AE%E4%B8%80%E4%B8%AA%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%EF%BC%8C%E6%8A%8A%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%9C%80%E8%A6%81%E5%B1%95%E7%A4%BA%E7%9A%84%E6%B7%98%E5%AE%9D%E5%95%86%E5%93%81%E6%95%B0%E6%8D%AE%E8%BF%94%E5%9B%9E%E7%BB%99%E8%88%9E%E5%A5%B3%E9%A1%B5%E9%9D%A2%E3%80%82">http://show.re.taobao.com/feature.htm，接收舞女页面的请求参数，根据一个业务逻辑，把客户端需要展示的淘宝商品数据返回给舞女页面。</a></p>
<p>如果广告投放的淘宝商品是一组促销的商品，则请求这个服务，获取实时的促销信息。如果不是促销的商品，则不需要请求这个实时的服务。</p>
<h4 id="淘宝商品数据服务的请求-1"><a href="#淘宝商品数据服务的请求-1" class="headerlink" title="淘宝商品数据服务的请求"></a>淘宝商品数据服务的请求</h4><p><strong>GET参数</strong></p>
<ul>
<li>cb：在舞女页面上定义的回调函数名，服务器端的响应会调用这个函数，处理商品数据。如tbcc_items_discounts_1369909156781。</li>
<li>auction_ids：需要获取实时数据的商品ID列表。如23639392129,17612793758,22441192364,17246494252,15176525473,22153008087,18419365960,18506205369,17190124163,23844364520</li>
<li>feature_names：需要获取的实时数据的字段，如promoPrice,promoOtherNeed</li>
</ul>
<p><strong>Cookie参数</strong></p>
<ul>
<li>cna：mqEwCpEPWVYCAfKFf3xLEFf3，域为.taobao.com，路径为&#x2F;，过期时间为25年后。</li>
</ul>
<p>当客户端存有TANX域的Cookie时，广告调度请求携带Cookie参数。没有Cookie，则不必携带。</p>
<h4 id="淘宝商品数据服务的响应-1"><a href="#淘宝商品数据服务的响应-1" class="headerlink" title="淘宝商品数据服务的响应"></a>淘宝商品数据服务的响应</h4><pre><code>如tbcc_items_discounts_1369909156781([&#123;
    &quot;promoOtherNeed&quot;: &quot;&quot;,
    &quot;promoPrice&quot;: &quot;&quot;,
    &quot;auction_id&quot;: &quot;22441192364&quot;
&#125;, ... ...])
</code></pre>
<h3 id="舞女养成系统"><a href="#舞女养成系统" class="headerlink" title="舞女养成系统"></a>舞女养成系统</h3><p>如果只是上述这些，那么我们可以说架构设计的合理、程序设计的水平高，但是还不至于让我们大肆褒扬，不至于让我们花如此大的篇幅分析学习。</p>
<p>我们看到了舞台上表演，舞女一手接过观众抛上来的参数，一手把参数抛给藏在背后的助手，接过助手抛回的衣服，迅速更衣换上。有时甚至还需要助手抛回活的鸽子、燃烧的火焰。</p>
<p>舞台上的这一切，都让人目炫神迷，赞叹不已。然而，你再一次买票来看的时候，却发现舞台上换人了。一样的动人，不一样的风情。如此许多次，你都不能记住他们每个人的名字。</p>
<p>你不禁要疑惑，幕布后面到底有多少神乎其技的美女？有什么样的一个养成系统在支撑这样层出不穷的表演？</p>
<h4 id="舞女的前台"><a href="#舞女的前台" class="headerlink" title="舞女的前台"></a>舞女的前台</h4><p>舞女的前台是CDN加速的静态服务器（strip.taobaocdn.com），所有对舞女页面的访问都是通过这里进行的。</p>
<p>这里存放着诸多的舞女页面，大约5分钟会与舞女的后台进行同步，及时反映出新增和修改。</p>
<h4 id="舞女的后台"><a href="#舞女的后台" class="headerlink" title="舞女的后台"></a>舞女的后台</h4><p>舞女的后台是CDN的源服务器，所有对页面的新增和修改，都是首先在这里进行，然后CDN会自动同步到舞女的前台。</p>
<h4 id="舞蹈学院"><a href="#舞蹈学院" class="headerlink" title="舞蹈学院"></a>舞蹈学院</h4><p>样式、功能等各各不同的舞女页面都是通过系统自动化生成的，而不是人工制作的。这个自动化的系统可以称为舞蹈学院。</p>
<p>舞蹈学院的出现，意味着阿里系的架构师们很好的解决了下面的一系列问题：</p>
<ul>
<li>拥有了自主设计的javascript模块依赖关系管理框架，如<a target="_blank" rel="noopener" href="https://github.com/etaoux/kslite">etaoux&#x2F;kslite</a>，<a target="_blank" rel="noopener" href="https://github.com/seajs/seajs">seajs&#x2F;seajs</a>。</li>
<li>使用了具备模块依赖关系管理能力的自动构建工具。</li>
<li>设计开发了使用人工设计的材料（代码片断）自动拼装HTML的程序。</li>
<li>使用了完善的JSDOC的工具和方法。</li>
<li>使用了完善的自动化单元测试的工具和方法。</li>
<li>各个代码片断的原始文件完成了良好的组织。</li>
<li>对开发团队也进行了良好的训练和组织。</li>
</ul>
<h4 id="舞蹈学院管理系统"><a href="#舞蹈学院管理系统" class="headerlink" title="舞蹈学院管理系统"></a>舞蹈学院管理系统</h4><p>这样一个庞大的自动化构建和拼装系统，没有一个可视化的管理系统是不可思议的。</p>
<h2 id="广告点击分析系统"><a href="#广告点击分析系统" class="headerlink" title="广告点击分析系统"></a>广告点击分析系统</h2><h3 id="逻辑架构-2"><a href="#逻辑架构-2" class="headerlink" title="逻辑架构"></a>逻辑架构</h3><p><img src="/images/projects/tanx-ssp/ad-click-stat.png" alt="逻辑架构"></p>
<h3 id="广告点击分析前端系统"><a href="#广告点击分析前端系统" class="headerlink" title="广告点击分析前端系统"></a>广告点击分析前端系统</h3><h4 id="加载前端系统文件"><a href="#加载前端系统文件" class="headerlink" title="加载前端系统文件"></a>加载前端系统文件</h4><p>广告点击分析前端系统的URL地址是<a target="_blank" rel="noopener" href="http://cdn.tanx.com/t/tanxclick.js%E3%80%82">http://cdn.tanx.com/t/tanxclick.js。</a></p>
<p>在加载的时候，可以带有参数。列表如下：</p>
<p><strong>Cookie参数</strong></p>
<ul>
<li>cna：域为.tanx.com，路径为&#x2F;，过期时间是25年以后。值如mqEwCpEPWVYCAfKFf3xLEFf3。</li>
</ul>
<p>当客户端存有TANX域的Cookie时，广告调度请求携带Cookie参数。没有Cookie，则不必携带。</p>
<h4 id="前端系统文件的响应"><a href="#前端系统文件的响应" class="headerlink" title="前端系统文件的响应"></a>前端系统文件的响应</h4><p>前端系统文件中，虽然只有区区几十行代码，但是承担了点击行为分析在浏览器客户端上的工作。</p>
<p>目测是在body上注册了点击事件。当用户点击的时候，进行一些统计行为。</p>
<h3 id="点击重定向统计分析"><a href="#点击重定向统计分析" class="headerlink" title="点击重定向统计分析"></a>点击重定向统计分析</h3><p>进行点击重定向统计分析的URL地址是：<a target="_blank" rel="noopener" href="http://rdstat.tanx.com/trd%E3%80%82">http://rdstat.tanx.com/trd。</a></p>
<p>当用户在点击广告进行重定向跳转的时候，发出统计请求。参数如下：</p>
<p><strong>Cookie参数</strong></p>
<ul>
<li>cna：域为.tanx.com，路径为&#x2F;，过期时间是25年以后。值如mqEwCpEPWVYCAfKFf3xLEFf3。</li>
</ul>
<p>当客户端存有TANX域的Cookie时，广告调度请求携带Cookie参数。没有Cookie，则不必携带。</p>
<p><strong>GET参数</strong></p>
<ul>
<li>f：</li>
<li>k：a09e279ad7f7a12a</li>
<li>p：mm_37227883_3484494_11371704</li>
<li>pvid：ac1797214e9e51a9b39900000018dcd6</li>
<li>d_r：redirect.simba.taobao.com_6899</li>
</ul>
<h3 id="点击重定向统计计数"><a href="#点击重定向统计计数" class="headerlink" title="点击重定向统计计数"></a>点击重定向统计计数</h3><p>提供点击重定向统计计数服务的URL地址是：<a target="_blank" rel="noopener" href="http://redirect.simba.taobao.com/rd%E3%80%82%E5%BD%93%E7%94%A8%E6%88%B7%E7%82%B9%E5%87%BB%E5%B9%BF%E5%91%8A%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E8%B4%9F%E8%B4%A3%E8%BF%9B%E8%A1%8C%E7%82%B9%E5%87%BB%E7%9A%84%E7%BB%9F%E8%AE%A1%E8%AE%A1%E6%95%B0%EF%BC%8C%E5%B9%B6%E6%A0%B9%E6%8D%AE%E5%8F%82%E6%95%B0%E8%B7%B3%E8%BD%AC%E8%87%B3%E6%9C%80%E7%BB%88%E7%9A%84%E7%9D%80%E9%99%86%E9%A1%B5%E9%9D%A2%EF%BC%88landingpage%EF%BC%89%E3%80%82">http://redirect.simba.taobao.com/rd。当用户点击广告的时候，负责进行点击的统计计数，并根据参数跳转至最终的着陆页面（landingpage）。</a></p>
<p>点击跳转时的参数如下：</p>
<p><strong>Cookie参数</strong></p>
<ul>
<li>cna：mqEwCpEPWVYCAfKFf3xLEFf3，域为.taobao.com，路径均为&#x2F;，过期时间是25年以后。</li>
<li>rdc：P3XUVZqJJhYLY4KiJHnfTK6UAKxdyp9LBUsbuR6TnOrUehYWBL3GaKKgLuzZERZb，域为.simba.taobao.com，路径均为&#x2F;，过期时间是一个会话周期。如果有此cookie，则携带此参数。没有这个cookie则不必携带。</li>
</ul>
<p><strong>GET参数</strong></p>
<ul>
<li>w：mmp4ptest</li>
<li>f：着陆页面的URL地址，如<a target="_blank" rel="noopener" href="http://tao.etao.com/auction?keyword=%C5%A3%EF%BF%BD%D0%BF%EF%BF%BD&catid=162205&refpid=tt_37227883_3484494_11371704&digest=E4F72AA836C280635D4B68077272D06E&crtid=204145027&itemid=19743755977&adgrid=191281107&eurl=http://click.simba.taobao.com/cc_im?p=&s=110631805&k=280&e=ZWZhqM4zvWg7cV%252Bisqn22t8bSgKjIMeIJv0WlAX%252BtYtQbbruHRRnvg59GO4ZnjechSzD2MI9ae0VcWHyHmjBU7uAJG68Oxh9pxE1ZBFsqdzEfoDg798s3B%252Bogj9kofCvUDUUDqa8gXYHDX7zWtfaOqb5dFReHwaR8UTulyn1o2Q4RXgcXpj38XMwXMmOtz2P0ksqglpB1x5n3laIHMmWXhdz%252BXgtQUth%252B3oHmwlYJqWdUREbe1MRAqlvZDS33RA0xc3vCBcBeda%252Fm6b4moZYyw%253D%253D&refpos=222_102680_25,n,i">http://tao.etao.com/auction?keyword=%C5%A3%D7%D0%BF%E3&amp;catid=162205&amp;refpid=tt_37227883_3484494_11371704&amp;digest=E4F72AA836C280635D4B68077272D06E&amp;crtid=204145027&amp;itemid=19743755977&amp;adgrid=191281107&amp;eurl=http%3A%2F%2Fclick.simba.taobao.com%2Fcc_im%3Fp%3D%26s%3D110631805%26k%3D280%26e%3DZWZhqM4zvWg7cV%252Bisqn22t8bSgKjIMeIJv0WlAX%252BtYtQbbruHRRnvg59GO4ZnjechSzD2MI9ae0VcWHyHmjBU7uAJG68Oxh9pxE1ZBFsqdzEfoDg798s3B%252Bogj9kofCvUDUUDqa8gXYHDX7zWtfaOqb5dFReHwaR8UTulyn1o2Q4RXgcXpj38XMwXMmOtz2P0ksqglpB1x5n3laIHMmWXhdz%252BXgtQUth%252B3oHmwlYJqWdUREbe1MRAqlvZDS33RA0xc3vCBcBeda%252Fm6b4moZYyw%253D%253D&amp;refpos=222_102680_25,n,i</a></li>
<li>k：edce2b64d0a4b4b1</li>
<li>pvid：ac17d84c7c3c51a9b39900000012325a_0</li>
<li>p：广告位编号，如tt_37227883_3484494_11371704</li>
</ul>
<p>如果还没有cookie的rdc的参数，则写cookie如下：</p>
<ul>
<li>rdc：sDMW0YXGMN%2Fx%2BvLWrRkUNK6UAKxdyp9LBUsbuR6TnOrUehYWBL3GaKKgLuzZERZb，&#x2F;，.simba.taobao.com，一个会话周期</li>
</ul>
<h2 id="阿里系的Cookie灯塔"><a href="#阿里系的Cookie灯塔" class="headerlink" title="阿里系的Cookie灯塔"></a>阿里系的Cookie灯塔</h2><h3 id="系统概览-3"><a href="#系统概览-3" class="headerlink" title="系统概览"></a>系统概览</h3><h4 id="逻辑架构-3"><a href="#逻辑架构-3" class="headerlink" title="逻辑架构"></a>逻辑架构</h4><p><img src="/images/projects/tanx-ssp/ali-cookie-beacon.png" alt="逻辑架构"></p>
<h4 id="时序略图-2"><a href="#时序略图-2" class="headerlink" title="时序略图"></a>时序略图</h4><p><img src="/images/projects/tanx-ssp/ali-cookie-beacon-sequence.png" alt="时序略图"></p>
<h3 id="阿里系的灯塔入口"><a href="#阿里系的灯塔入口" class="headerlink" title="阿里系的灯塔入口"></a>阿里系的灯塔入口</h3><p>TANX前端系统的模块入口点（tanxssp&#x2F;main.js）脚本在完成了广告任务后，还负有为阿里系的产品识别用户的重要职责。</p>
<p>如果发现客户端还没有用户Cookie标识，则创建一个隐身的iframe，去加载阿里系的Cookie灯塔入口（<a target="_blank" rel="noopener" href="http://cdn.tanx.com/t/acookie/acbeacon2.html%EF%BC%89%E3%80%82">http://cdn.tanx.com/t/acookie/acbeacon2.html）。</a></p>
<p>灯塔入口的响应是一个纯粹的HTML文件，负责创建一组img标签，请求TANX、淘宝和阿里妈妈的Cookie标识服务。</p>
<h3 id="TANX系统的Cookie标识服务"><a href="#TANX系统的Cookie标识服务" class="headerlink" title="TANX系统的Cookie标识服务"></a>TANX系统的Cookie标识服务</h3><p>TANX系统的Cookie标识服务地址是：<a target="_blank" rel="noopener" href="http://acookie.tanx.com/1.gif%E3%80%82">http://acookie.tanx.com/1.gif。</a></p>
<h4 id="请求Cookie服务"><a href="#请求Cookie服务" class="headerlink" title="请求Cookie服务"></a>请求Cookie服务</h4><p>在请求时携带一组参数，列表如下：</p>
<p><strong>GET参数</strong></p>
<ul>
<li>cache：39</li>
<li>pre：<a target="_blank" rel="noopener" href="http://www.120ask.com/zxmrk/28/28109815.htm">http://www.120ask.com/zxmrk/28/28109815.htm</a></li>
</ul>
<h4 id="阿里妈妈统计平台中转"><a href="#阿里妈妈统计平台中转" class="headerlink" title="阿里妈妈统计平台中转"></a>阿里妈妈统计平台中转</h4><p>在请求的过程中，302跳转至统一的Cookie服务平台（阿里妈妈统计平台中转，<a target="_blank" rel="noopener" href="http://hz.mmstat.com/a%EF%BC%89%E3%80%82">http://hz.mmstat.com/a）。</a></p>
<p>跳转时携带一组参数，如下：</p>
<p><strong>GET参数</strong></p>
<ul>
<li>XzOzGe85AA：2054790862</li>
<li>K9g5CWjDh9：pQenF85FcLPkh5KHRNXHUpLjoRVRrrFwlDdEobZ5amZ40M9ELRJ7N7w2YdmxOxd4fC0poqjSu6GXZd67y2T7LxuEby5LrhnUXL2Jr6vaUp2BT-iFnvURy31Ka-5se17I4RGFKNwWSwXtcXXz9qtG1g__</li>
</ul>
<p>阿里妈妈统计平台会写下如下的一组cookie标识：</p>
<ul>
<li>cna：mqEwCpEPWVYCAfKFf3xLEFf3，域为.mmstat.com，路径为&#x2F;，过期时间为25年以后。</li>
<li>ac_session：mqEwCpEPWVYCAfKFf3xLEFf3_1370076058_1，域为.mmstat.com，路径为&#x2F;，过期时间为一个会话周期。</li>
</ul>
<h4 id="跳转回最初的请求"><a href="#跳转回最初的请求" class="headerlink" title="跳转回最初的请求"></a>跳转回最初的请求</h4><p>在阿里妈妈统计平台在写下cookie标识后，携带一组参数，再302跳转回最初的TANX Cookie服务地址（<a target="_blank" rel="noopener" href="http://acookie.tanx.com/1.gif%EF%BC%89%E3%80%82">http://acookie.tanx.com/1.gif）。</a></p>
<p>参数如下：</p>
<p><strong>GET参数</strong></p>
<ul>
<li>cache：546</li>
<li>pre：<a target="_blank" rel="noopener" href="http://www.120ask.com/zxmrk/28/28109815.htm">http://www.120ask.com/zxmrk/28/28109815.htm</a></li>
<li>XzOzGe85AA：1951151388</li>
<li>a3G4ApKGeL：ywhlurt-xX8LiWFSVw3T7ZlX7vEJe5yCfUrOuLDawE0_</li>
</ul>
<p>TANX Cookie服务会写下如下的cookie标识：</p>
<ul>
<li>cna：mqEwCpEPWVYCAfKFf3xLEFf3，域为.tanx.com，路径为&#x2F;，过期时间为25年以后。</li>
</ul>
<h3 id="淘宝系统的Cookie标识服务"><a href="#淘宝系统的Cookie标识服务" class="headerlink" title="淘宝系统的Cookie标识服务"></a>淘宝系统的Cookie标识服务</h3><p>淘宝系统的Cookie标识服务地址是：<a target="_blank" rel="noopener" href="http://acookie.taobao.com/1.gif%E3%80%82">http://acookie.taobao.com/1.gif。</a></p>
<h4 id="请求Cookie服务-1"><a href="#请求Cookie服务-1" class="headerlink" title="请求Cookie服务"></a>请求Cookie服务</h4><p>在请求时携带一组参数，列表如下：</p>
<p><strong>GET参数</strong></p>
<ul>
<li>cache：546</li>
<li>pre：<a target="_blank" rel="noopener" href="http://www.120ask.com/zxmrk/28/28109815.htm">http://www.120ask.com/zxmrk/28/28109815.htm</a></li>
</ul>
<h4 id="阿里妈妈统计平台中转-1"><a href="#阿里妈妈统计平台中转-1" class="headerlink" title="阿里妈妈统计平台中转"></a>阿里妈妈统计平台中转</h4><p>在请求的过程中，302跳转至统一的Cookie服务平台（阿里妈妈统计平台中转，<a target="_blank" rel="noopener" href="http://hz.mmstat.com/a%EF%BC%89%E3%80%82">http://hz.mmstat.com/a）。</a></p>
<p>跳转时携带一组参数，如下：</p>
<p><strong>GET参数</strong></p>
<ul>
<li>XzOzGe85AA：1448955166</li>
<li>K9g5CWjDh9：fn.BCSv-Gb2yypgynY4HgfcEFPHD4y4BngjHq-AGw8X-5JPeAQ0vHAMGF2jRFPENJi8DokZDamOueFHo5mOI-H9JL5PV7h.PODbi9MStM3vVXPKPT50U77iozVcz0y0pT5RdBZVKtJbm6kngnH25WQ__</li>
</ul>
<p><strong>Cookie参数</strong></p>
<ul>
<li>cna：mqEwCpEPWVYCAfKFf3xLEFf3，域为.mmstat.com，路径为&#x2F;，过期时间为25年以后。</li>
<li>ac_session：mqEwCpEPWVYCAfKFf3xLEFf3_1370076058_1，域为.mmstat.com，路径为&#x2F;，过期时间为一个会话周期。</li>
</ul>
<p>阿里妈妈统计平台会写下如下的cookie标识：</p>
<ul>
<li>ac_session：mqEwCpEPWVYCAfKFf3xLEFf3_1370076061_2，域为.mmstat.com，路径为&#x2F;，过期时间为一个会话周期。</li>
</ul>
<h4 id="跳转回最初的请求-1"><a href="#跳转回最初的请求-1" class="headerlink" title="跳转回最初的请求"></a>跳转回最初的请求</h4><p>在阿里妈妈统计平台在写下cookie标识后，携带一组参数，再302跳转回最初的淘宝Cookie服务地址（<a target="_blank" rel="noopener" href="http://acookie.taobao.com/1.gif%EF%BC%89%E3%80%82">http://acookie.taobao.com/1.gif）。</a></p>
<p>参数如下：</p>
<p><strong>GET参数</strong></p>
<ul>
<li>cache：546</li>
<li>pre：<a target="_blank" rel="noopener" href="http://www.120ask.com/zxmrk/28/28109815.htm">http://www.120ask.com/zxmrk/28/28109815.htm</a></li>
<li>XzOzGe85AA：895282041</li>
<li>a3G4ApKGeL：Aw5aWvwYEK.tZE-0ecjMOxKY73ASRCO4cPGbgChnZSg_</li>
</ul>
<p>淘宝Cookie服务会写下如下的cookie标识：</p>
<ul>
<li>cna：mqEwCpEPWVYCAfKFf3xLEFf3，域为.taobao.com，路径为&#x2F;，过期时间为25年以后。</li>
<li>sc：8e249d1d，域为.acookie.taobao.com，路径为&#x2F;，过期时间为一个会话周期。</li>
<li>linezing_session：f4718b0ec8f7a4569b93c684_1370076062_1，域为.acookie.taobao.com，路径为&#x2F;，过期时间为一个会话周期。</li>
</ul>
<h3 id="阿里妈妈系统的Cookie标识服务"><a href="#阿里妈妈系统的Cookie标识服务" class="headerlink" title="阿里妈妈系统的Cookie标识服务"></a>阿里妈妈系统的Cookie标识服务</h3><p>淘宝系统的Cookie标识服务地址是：<a target="_blank" rel="noopener" href="http://acookie.alimama.com/1.gif%E3%80%82">http://acookie.alimama.com/1.gif。</a></p>
<h4 id="请求Cookie服务-2"><a href="#请求Cookie服务-2" class="headerlink" title="请求Cookie服务"></a>请求Cookie服务</h4><p>在请求时携带一组参数，列表如下：</p>
<p><strong>GET参数</strong></p>
<ul>
<li>cache：546</li>
<li>pre：<a target="_blank" rel="noopener" href="http://www.120ask.com/zxmrk/28/28109815.htm">http://www.120ask.com/zxmrk/28/28109815.htm</a></li>
</ul>
<h4 id="阿里妈妈统计平台中转-2"><a href="#阿里妈妈统计平台中转-2" class="headerlink" title="阿里妈妈统计平台中转"></a>阿里妈妈统计平台中转</h4><p>在请求的过程中，302跳转至统一的Cookie服务平台（阿里妈妈统计平台中转，<a target="_blank" rel="noopener" href="http://hz.mmstat.com/a%EF%BC%89%E3%80%82">http://hz.mmstat.com/a）。</a></p>
<p>跳转时携带一组参数，如下：</p>
<p><strong>GET参数</strong></p>
<ul>
<li>XzOzGe85AA：1521901734</li>
<li>K9g5CWjDh9：brdpYvU0Q0K-m3lpaFBdlf-MRUhoOSYqLOyFOibOKpyXscmeV9lAgjthKGSAgdREEtNT7ubH.Y9Oh-7S5SwzNH0zW1R0fSEsj53LMc8tYLPPVCiinE8L-nIrO0-hlvr589umMUli2WMig2IEPKL44Q__</li>
</ul>
<p><strong>Cookie参数</strong></p>
<ul>
<li>cna：mqEwCpEPWVYCAfKFf3xLEFf3，域为.mmstat.com，路径为&#x2F;，过期时间为25年以后。</li>
<li>ac_session：mqEwCpEPWVYCAfKFf3xLEFf3_1370076058_1，域为.mmstat.com，路径为&#x2F;，过期时间为一个会话周期。</li>
</ul>
<p>阿里妈妈统计平台会写下如下的cookie标识：</p>
<ul>
<li>ac_session：mqEwCpEPWVYCAfKFf3xLEFf3_1370076061_2，域为.mmstat.com，路径为&#x2F;，过期时间为一个会话周期。</li>
</ul>
<h4 id="跳转回最初的请求-2"><a href="#跳转回最初的请求-2" class="headerlink" title="跳转回最初的请求"></a>跳转回最初的请求</h4><p>在阿里妈妈统计平台在写下cookie标识后，携带一组参数，再302跳转回最初的阿里妈妈Cookie服务地址（<a target="_blank" rel="noopener" href="http://acookie.alimama.com/1.gif%EF%BC%89%E3%80%82">http://acookie.alimama.com/1.gif）。</a></p>
<p>参数如下：</p>
<p><strong>GET参数</strong></p>
<ul>
<li>cache：546</li>
<li>pre：<a target="_blank" rel="noopener" href="http://www.120ask.com/zxmrk/28/28109815.htm">http://www.120ask.com/zxmrk/28/28109815.htm</a></li>
<li>XzOzGe85AA：1922922509</li>
<li>a3G4ApKGeL：yRA2RMr5506V9xuekIeOaPbr8-P069UHRL-HX.fuJ.I_</li>
</ul>
<p>阿里妈妈Cookie服务会写下如下的cookie标识：</p>
<ul>
<li>cna：mqEwCpEPWVYCAfKFf3xLEFf3，域为.alimama.com，路径为&#x2F;，过期时间为25年以后。</li>
</ul>
<h2 id="静态文件资源服务"><a href="#静态文件资源服务" class="headerlink" title="静态文件资源服务"></a>静态文件资源服务</h2><h3 id="逻辑架构-4"><a href="#逻辑架构-4" class="headerlink" title="逻辑架构"></a>逻辑架构</h3><p><img src="/images/projects/tanx-ssp/static-server.png" alt="逻辑架构"></p>
<h3 id="设计意图分析"><a href="#设计意图分析" class="headerlink" title="设计意图分析"></a>设计意图分析</h3><p>img.alimama.cn存储系统中核心的静态的文件，比如通用图标、默认广告图片等。其他的产品图片，以及舞女页面的样式需要的图片资源等，分布在4台以上的服务器上。这些服务器都是使用了CDN加速的。</p>
<p>10个淘宝商品的图片等资源分布在4个域名的服务器下，使浏览器可以并行的同时加载图片，而不必加载完一张图片，再加载下一张。</p>
<p>以一张淘宝商品的图片地址（<a target="_blank" rel="noopener" href="http://img01.taobaocdn.com/bao/uploaded/i1/1014142759/T2Njj8XbJXXXXXXXXX_!!1014142759.jpg_250x250.jpg%EF%BC%89%E4%B8%BA%E4%BE%8B%E5%88%86%E6%9E%90%EF%BC%8C%E5%A4%A7%E7%BA%A6%E7%9F%A5%E9%81%93%E4%BB%A5%E4%B8%8B%E8%AE%BE%E8%AE%A1%E6%84%8F%E5%9B%BE%EF%BC%9A">http://img01.taobaocdn.com/bao/uploaded/i1/1014142759/T2Njj8XbJXXXXXXXXX_!!1014142759.jpg_250x250.jpg）为例分析，大约知道以下设计意图：</a></p>
<ul>
<li>除了商品上传的图片外，其他有关商品的静态文件资源，也是分布存储在几个域名的服务器下的。</li>
<li>有与img01.taobaocdn.com对应的i1目录，说明这些资源即可以分布在4台服务器上，也可以合并存储在同一台服务器上，有良好的伸缩性。</li>
</ul>
<h2 id="学习后记"><a href="#学习后记" class="headerlink" title="学习后记"></a>学习后记</h2><h3 id="外围系统"><a href="#外围系统" class="headerlink" title="外围系统"></a>外围系统</h3><ul>
<li>log.mmstat.com和dt.tongji.linezing.com是在一淘的着陆页上观察到的，在整体的阿里系系统中肯定也是很重要的统计系统。虽然跟本次分析有丝丝楼缕的关系，因为不是本次分析的主题，所以不做深入分析。</li>
<li>t.alimama.com和z.alimama.com这两个域名，只在系统代码中看到，并没有观察到发出请求，所以不好分析给出评论。但是，网上纷传这是收集用户信息的。网上姑枉传之，我们姑枉听之吧，不做进一步的深入分析了。</li>
</ul>
<h3 id="代码评点"><a href="#代码评点" class="headerlink" title="代码评点"></a>代码评点</h3><ul>
<li>阿里系广告前端系统的设计水平，以及整体系统的架构水平，已经与google等国际水平毫不逊色。</li>
<li>有3个或3个以上的javascript架构师，以及他们领导的开发团队，参与了系统的开发。如<a target="_blank" rel="noopener" href="https://github.com/seajs/seajs">seajs&#x2F;seajs</a>、<a target="_blank" rel="noopener" href="https://github.com/etaoux/kslite">etaoux&#x2F;kslite</a>、<a target="_blank" rel="noopener" href="https://github.com/kissyteam/kissy">kissyteam&#x2F;kissy</a>。</li>
<li>可能是由于并购等历史原因，团队协作并不理想，或者说没有达到天衣无缝的默契。</li>
<li>希望阿里系的架构师们能够打破隔阂、通力协作，像Booch、Rumbaugh和Jacobson对UML的贡献一样，为阿里系、也为中国，贡献一个统一的javascript架构。</li>
</ul>
<h3 id="参考引用"><a href="#参考引用" class="headerlink" title="参考引用"></a>参考引用</h3><ul>
<li><a target="_blank" rel="noopener" href="http://c.tanx.com/">TANX SSP 橱窗推广</a></li>
<li><a target="_blank" rel="noopener" href="http://www.rtbchina.com/">www.rtbchina.com</a></li>
<li><a target="_blank" rel="noopener" href="http://baike.soso.com/v59874706.htm">SOSO百科的TANX SSP词条</a></li>
</ul>

      
    </div>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/articles/it-lessons-2013-05-23-install-firebug.html" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">前一篇</strong>
      <div class="article-nav-title">
        
          Firebug插件安装教程
        
      </div>
    </a>
  
  
    <a href="/articles/poem-buddha-2013-05-06-bei-wei.html" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">后一篇</strong>
      <div class="article-nav-title">卑微</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">
      <img src="/images/weixin.png" alt="weixin" width="100%" />
    </h3>
    <div class="widget">
      <ul class="self-media-list">
        
          <li>
            <a target="_blank" rel="noopener" href="https://weread.qq.com/">微信读书</a>
          </li>
        
          <li>
            <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/cgi-bin/home">微信公众号</a>
          </li>
        
          <li>
            <a target="_blank" rel="noopener" href="https://channels.weixin.qq.com/platform">视频号助手</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/essay/">札记随笔</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/essay/arts/">文艺随笔</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/essay/travel/">老周游记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/essay/read/">读书笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/essay/thinking/">思考札记</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/classic/">典籍学习</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/classic/hou-han-shu/">后汉书</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/classic/qing-shi/">清史稿</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/classic/sutra/">佛经</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/classic/analects/">论语</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/classic/su-wen/">黄帝内经素问</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/poem/">培公诗抄</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/poem/a-2015/">2015 ~ 2024</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/poem/a-2010/">2010 ~ 2014</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/poem/a-2004/">2004 ~ 2009</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/poem/b-2004/">~ 2004 年</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/poem/buddha/">禅宗心得</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/poem/characters/">人物</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/catalog/">藏书目录</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/catalog/bookcase/">在架图书</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/catalog/table/">封存图书</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/">IT</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/it/env/">开发环境</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/manual/">常用文档</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/studio/">学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/lessons/">培训教程</a></li></ul></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 VET. 周培公<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/proposals" class="mobile-nav-link">写作计划</a>
  
    <a href="/books" class="mobile-nav-link">藏书目录</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>